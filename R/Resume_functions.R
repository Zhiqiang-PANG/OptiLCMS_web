## Perform Running Pipeline - script

#' Initializing running plan
#' @param type Initialized plan type for a resumable running mode. Can be "raw_opt" for automated optimization option, or "raw_ms" for customized pipeline.
#' @param path this parameter is used to define the working directory (also is where the raw spectra data exists).
#' @author Zhiqiang Pang \email{zhiqiang.pang@mail.mcgill.ca} Jeff Xia \email{jeff.xia@mcgill.ca}
#' Mcgill University
#' License: GNU GPL (>= 2)
#' @export
InitializaPlan <- function(type="spec", path){
  
  if(path != ""){
    setwd(path);
    fullUserPath <<- path;
  } else {
    fullUserPath <<- "";
  };
  
  MessageOutput(paste0("Running Status -- Plan Initialized Successfully at: ", Sys.time(), "\nPlease define your running plan ..."), "\n", 0);
  
  temp.path <- paste0(getwd(), "/temp/");
  
  if(dir.exists(temp.path)){
    unlink(temp.path, recursive = TRUE, force = TRUE);
  }
  
  #=============== raw_opt
  if (type == "raw_opt") {
    
    plan.path <- paste0(getwd(), "/temp/plan");
    
    if (!dir.exists(plan.path)) {
      dir.create(paste0(getwd(), "/temp/plan"),
                 recursive = T)
    }
    
    .running.as.plan <<- T;
    plan <- new("ResumingePlan");
    .plan_count <<- plan@PlanNumber <- 0;
    plan@WorkingDir <- fullUserPath;
    
    saveRDS(plan, file = paste0(plan.path, "/plan.rds"));
    saveRDS(.running.as.plan, file = paste0(plan.path, "/running.as.plan.rds"));
    saveRDS(.plan_count, file = paste0(plan.path, "/plan_count.rds"));
    #----------------------
    .optimize_switch <<- TRUE;
    switch.path <- paste0(getwd(), "/temp/plan")
    saveRDS(.optimize_switch,
            file = paste0(switch.path, "/optimize_switch_", .plan_count, ".rds"))
    
    #----------------------
    envir.path <- paste0(getwd(), "/temp/envir")
    if (!dir.exists(envir.path)) {
      dir.create(paste0(getwd(), "/temp/envir"),
                 recursive = T)
    }
    
    envir <<- new.env()
    saveRDS(envir, file = paste0(envir.path, "/envir.rds"))
    #----------------------
    if (.on.public.web) {
      rawFileNames <- paste0(getwd(), "/temp/plan")
      saveRDS(rawfilenms,
              file = paste0(rawFileNames, "/rawfilenms_", .plan_count, ".rds"))
    }
    #----------------------
    
    if (exists(".plan_count") & .plan_count > 0) {
      return(plan)
    }
  }
  
  #================== raw_ms
  if (type == "raw_ms") {
    plan.path <- paste0(getwd(), "/temp/plan")
    
    if (!dir.exists(plan.path)) {
      dir.create(paste0(getwd(), "/temp/plan"),
                 recursive = T)
    }
    
    #---------------
    .running.as.plan <<- T;
    plan <- new("ResumingePlan");
    .plan_count <<- plan@PlanNumber <- 0;
    plan@WorkingDir <- fullUserPath;
    
    saveRDS(plan, file = paste0(plan.path, "/plan.rds"));
    saveRDS(.running.as.plan, file = paste0(plan.path, "/running.as.plan.rds"));
    saveRDS(.plan_count, file = paste0(plan.path, "/plan_count.rds"));
    #----------------------
    .optimize_switch <<- FALSE;
    switch.path <- paste0(getwd(), "/temp/plan");
    saveRDS(.optimize_switch,
            file = paste0(switch.path, "/optimize_switch_", .plan_count, ".rds"));
    
    #----------------------
    envir.path <- paste0(getwd(), "/temp/envir")
    if (!dir.exists(envir.path)) {
      dir.create(paste0(getwd(), "/temp/envir"),
                 recursive = T)
    }
    
    envir <<- new.env();
    saveRDS(envir, file = paste0(envir.path, "/envir.rds"))
    #----------------------
    rawFileNames <- paste0(getwd(), "/temp/plan")
    
    if (.on.public.web) {
      saveRDS(rawfilenms,
              file = paste0(rawFileNames, "/rawfilenms_", .plan_count, ".rds"))
    } else {
      # do nothing for local
    }
    
    #----------------------
    if (exists(".plan_count") & .plan_count > 0) {
      return(plan)
    }
  }
  
  ## Recording cache file information
  record.info <- matrix(nrow = 30, ncol = 2)
  record.path <- paste0(getwd(), "/temp/records")
  
  if (!dir.exists(record.path)) {
    dir.create(paste0(getwd(), "/temp/records"),
               recursive = T)
  }
  
  saveRDS(record.info, file = paste0(record.path, "/records.rds"))
  
  return(plan)
  #return(.set.mSet(plan))
}

#' running.plan
#' @param plan ResummingPlan object. The object is generated by 'InitializaPlan' function.
#' @param ... Multiple Processing commands can be input here.
#' @author Zhiqiang Pang \email{zhiqiang.pang@mail.mcgill.ca} Jeff Xia \email{jeff.xia@mcgill.ca}
#' Mcgill University
#' License: GNU GPL (>= 2)
#' @export
running.plan <- function(plan=NULL,...){
  
  #plan <- .get.current.plan(plan);
  commands <<- match.call(expand.dots = FALSE)$...
  
  ## Declare controller
  plan@running.controller <- controller.resetter();
  ##
  
  if (!length(commands)) {
    stop("No command provided to run !");
  }
  
  plan@PlanNumber <- .plan_count <<- .plan_count + 1;
  
  CommandsVerified <- CommandsVerify(commands);
  MessageOutput("Commands Origanization Finished!", ecol = "\n", NULL);
  
  plan@CommandSet[[paste0("command_set_",.plan_count)]] <- CommandsVerified;
  
  plan.path <- paste0(getwd(), "/temp/plan");
  saveRDS(plan, file = paste0(plan.path, "/plan.rds"));
  saveRDS(.plan_count, file = paste0(plan.path, "/plan_count.rds"));
  
  recordMarker_resetter(.plan_count);
  
  return(plan)
}

#' @noRd
.get.current.plan <- function(plan){
  
  if (is.null(plan)){
    return(list())
  } else {
    return (plan)
  }
  
}

#' ExecutePlan
#' @param plan ResummingPlan object. The object is generated by running.plan() function.
#' @author Zhiqiang Pang \email{zhiqiang.pang@mail.mcgill.ca} Jeff Xia \email{jeff.xia@mcgill.ca}
#' Mcgill University
#' License: GNU GPL (>= 2)
#' @export
ExecutePlan <- function(plan=NULL){
  cat("Current Working Directory: ",getwd(),"\n");
  if (is.null(plan)){
    stop("No running plan input. Please design you plan first with 'running.plan' function !")
  };
  
  # Reset running.controller to make sure everything is normal at beginning
  plan@running.controller <- controller.resetter();
  
  if (length(plan@CommandSet) == 1){
    
    if(!exists("envir",envir = ".GlobalEnv")){
      envir <<- new.env()
    }
    
    envir$rc <<- plan@running.controller;
    perform.plan(plan@CommandSet[["command_set_1"]]);
    
    envir.path <- paste0(getwd(),"/temp/envir");
    saveRDS(envir, file = paste0(envir.path,"/envir.rds"));
    
  } else if (length(plan@CommandSet) > 1) {
    
    ## This is the most important part for the whole pipeline
    ## Module 1-6: Dectect whether the parameters changed or not so as to operate the whole pipeline
    
    last_command_set <- plan@CommandSet[[.plan_count-1]];
    new_command_set <- plan@CommandSet[[.plan_count]];
    
    if(class(last_command_set) != class(new_command_set)){
      
      plan@running.controller <- controller.resetter();
      
    } else {
      plan <-
        controller.modifier(new_command_set,
                            last_command_set,
                            plan)
    }

    ## Module 7 - Detect whether some steps have been run in last plan excuting process (Secondary Decision switch)
    plan <- recording_identifier(plan);
    
    ## Module 8 - Dectect whether current plan type (raw_ms or raw_pre) is different from the last one (Final Decision switch)
    # plan <- planType_identifier(plan);
    
    envir$rc <<- plan@running.controller
    # define.plan.controller <- str2lang('rc <- plan$running.controller');
    # eval (define.plan.controller,envir = envir);
    #perform.plan(new_command_set);
    
    if(class(new_command_set) == "CustCommandSet"){
      MessageOutput(mes = "Step 1/6: Ready to start the customized pipeline !",
                    ecol = "\n",
                    progress = 10.0)
    }
    
    mSetInfo <- tryCatch(perform.plan(new_command_set), error = function(e){e});
    
    if (class(mSetInfo)[1]=="simpleError"){
      print_mes <- paste0("<font color=\"red\">","\nERROR:",mSetInfo$message,"</font>");
      write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
      stop(paste0("EXCEPTION POINT CODE: ", mSetInfo$message));
    }
    
    envir.path <- paste0(getwd(),"/temp/envir");
    saveRDS(envir, file = paste0(envir.path,"/envir.rds"));
    
  } else {
    stop("Wrong plan has been prepared !");
  }
  
}

#' @noRd
recording_identifier <- function(plan) {
  
  record.path <- paste0(getwd(),"/temp/records");
  
  if(file.exists(paste0(record.path,"/records_marker_",.plan_count-1,".rds"))){
    record.marker_last <- readRDS(paste0(record.path,"/records_marker_",.plan_count-1,".rds"));
  } else {
    recordMarker_resetter(.plan_count-1);
    record.marker_last <- readRDS(paste0(record.path,"/records_marker_",.plan_count-1,".rds"));
  }
  
  
  # If things were not run last time, forcedly start running the slot this time
  if(!as.logical(record.marker_last[1,2])){plan@running.controller@ROI_extract[1] <- TRUE};
  if(!as.logical(record.marker_last[2,2])){plan@running.controller@ROI_extract[2] <- TRUE};
  if(!as.logical(record.marker_last[3,2])){plan@running.controller@ROI_extract[3] <- TRUE};
  if(!as.logical(record.marker_last[4,2])){plan@running.controller@ROI_extract[4] <- TRUE};
  
  if(!as.logical(record.marker_last[5,2])){plan@running.controller@data_import[1] <- TRUE}
  if(!as.logical(record.marker_last[6,2])){plan@running.controller@data_import[2] <- TRUE}
  if(!as.logical(record.marker_last[7,2])){plan@running.controller@data_import[3] <- TRUE}
  if(!as.logical(record.marker_last[8,2])){plan@running.controller@data_import[4] <- TRUE}
  
  if(!as.logical(record.marker_last[9,2])){plan@running.controller@peak_profiling[1] <- TRUE}
  if(!as.logical(record.marker_last[10,2])){plan@running.controller@peak_profiling[2] <- TRUE}
  if(!as.logical(record.marker_last[11,2])){plan@running.controller@peak_profiling[3] <- TRUE}
  if(!as.logical(record.marker_last[12,2])){plan@running.controller@peak_profiling[4] <- TRUE}
  
  if(!as.logical(record.marker_last[13,2])){plan@running.controller@peak_annotation[1] <- TRUE}
  if(!as.logical(record.marker_last[14,2])){plan@running.controller@peak_annotation[2] <- TRUE}
  if(!as.logical(record.marker_last[15,2])){plan@running.controller@peak_annotation[3] <- TRUE}
  if(!as.logical(record.marker_last[16,2])){plan@running.controller@peak_annotation[4] <- TRUE}
  
  if(!as.logical(record.marker_last[17,2])){plan@running.controller@others_1[1] <- TRUE}
  if(!as.logical(record.marker_last[18,2])){plan@running.controller@others_1[2] <- TRUE}
  if(!as.logical(record.marker_last[19,2])){plan@running.controller@others_1[3] <- TRUE}
  if(!as.logical(record.marker_last[20,2])){plan@running.controller@others_1[4] <- TRUE}
  
  if(!as.logical(record.marker_last[21,2])){plan@running.controller@operators[1] <- TRUE}
  if(!as.logical(record.marker_last[22,2])){plan@running.controller@operators[2] <- FALSE} # Switch off this operator at the end of plan define
  if(!as.logical(record.marker_last[23,2])){plan@running.controller@operators[3] <- FALSE} # Switch off this operator at the end of plan define
  if(!as.logical(record.marker_last[24,2])){plan@running.controller@operators[4] <- FALSE}
  if(!as.logical(record.marker_last[25,2])){plan@running.controller@operators[5] <- FALSE}
  if(!as.logical(record.marker_last[26,2])){plan@running.controller@operators[6] <- FALSE}
  if(!as.logical(record.marker_last[27,2])){plan@running.controller@operators[7] <- FALSE}
  if(!as.logical(record.marker_last[28,2])){plan@running.controller@operators[8] <- FALSE}
  
  plan@RunningHistory@setNO <- .plan_count-1;
  plan@RunningHistory@FunishedPosition <- which(as.logical(record.marker_last[,2]))
  
  return(plan)
  
}

#' @noRd
recordMarker_resetter <- function(.plan_count){
  
  ## Recording initial markers about being ran or not
  record.marker <- matrix(nrow = 28,ncol = 2);
  record.marker[,1] <- c("ROI_extract_1","ROI_extract_2","ROI_extract_3","ROI_extract_4",
                         "data_import_1","data_import_2","data_import_3","data_import_4",
                         "profiling_1","profiling_2","profiling_3","profiling_4",
                         "peak_annotation_1","peak_annotation_2","peak_annotation_3","peak_annotation_4",
                         "others_1","others_2","others_3","others_4",
                         "operators_1","operators_2","operators_3","operators_4",
                         "operators_5","operators_6","operators_7","operators_8");
  record.marker[,2] <- rep(FALSE, 28);
  record.path <- paste0(getwd(),"/temp/records");
  
  saveRDS(record.marker,file = paste0(record.path,"/records_marker_",.plan_count,".rds"));
  
}

#' @noRd
marker_record <- function(functionNM){
  record.path <- paste0(getwd(),"/temp/records");
  
  if (!file.exists(paste0(record.path,"/records_marker_",.plan_count,".rds"))){
    record.marker <- matrix(nrow = 28,ncol = 2);
    record.marker[,1] <- c("ROI_extract_1","ROI_extract_2","ROI_extract_3","ROI_extract_4",
                           "data_import_1","data_import_2","data_import_3","data_import_4",
                           "profiling_1","profiling_2","profiling_3","profiling_4",
                           "peak_annotation_1","peak_annotation_2","peak_annotation_3","peak_annotation_4",
                           "others_1","others_2","others_3","others_4",
                           "operators_1","operators_2","operators_3","operators_4",
                           "operators_5","operators_6","operators_7","operators_8");
    record.marker[,2] <- rep(FALSE, 28);
    saveRDS(record.marker,file = paste0(record.path,"/records_marker_",.plan_count,".rds"))
  } else {
    record.marker <- readRDS(paste0(record.path,"/records_marker_",.plan_count,".rds"));
  };
  
  
  # If this step has been run at ".plan_count" time, is will be marked as T
  if(functionNM=="ROI_extract_c1"){record.marker[1,2] <- TRUE};
  if(functionNM=="ROI_extract_c2"){record.marker[2,2] <- TRUE};
  if(functionNM=="ROI_extract_c3"){record.marker[3,2] <- TRUE};
  if(functionNM=="ROI_extract_c4"){record.marker[4,2] <- TRUE};
  
  if(functionNM=="data_import_c1"){record.marker[5,2] <- TRUE};
  if(functionNM=="data_import_c2"){record.marker[6,2] <- TRUE};
  if(functionNM=="data_import_c3"){record.marker[7,2] <- TRUE}; # RETAINED 
  if(functionNM=="data_import_c4"){record.marker[8,2] <- TRUE}; # RETAINED 
  
  if(functionNM=="peak_profiling_c1"){record.marker[9,2] <- TRUE};
  if(functionNM=="peak_profiling_c2"){record.marker[10,2] <- TRUE};
  if(functionNM=="peak_profiling_c3"){record.marker[11,2] <- TRUE};
  if(functionNM=="peak_profiling_c4"){record.marker[12,2] <- TRUE};
  
  if(functionNM=="peak_annotation_c1"){record.marker[13,2] <- TRUE};
  if(functionNM=="peak_annotation_c2"){record.marker[14,2] <- TRUE}; # RETAINED 
  if(functionNM=="peak_annotation_c3"){record.marker[15,2] <- TRUE}; # RETAINED 
  if(functionNM=="peak_annotation_c4"){record.marker[16,2] <- TRUE}; # RETAINED 
  
  if(functionNM=="others_c1"){record.marker[17,2] <- TRUE};
  if(functionNM=="others_c2"){record.marker[18,2] <- TRUE}; # RETAINED 
  if(functionNM=="others_c3"){record.marker[19,2] <- TRUE}; # RETAINED 
  if(functionNM=="others_c4"){record.marker[19,2] <- TRUE}; # RETAINED 
  
  if(functionNM=="operators_c1"){record.marker[13,2] <- TRUE};
  if(functionNM=="operators_c2"){record.marker[14,2] <- TRUE};
  if(functionNM=="operators_c3"){record.marker[15,2] <- TRUE};
  if(functionNM=="operators_c4"){record.marker[16,2] <- TRUE};
  if(functionNM=="operators_c5"){record.marker[17,2] <- FALSE}; # RETAINED 
  if(functionNM=="operators_c6"){record.marker[18,2] <- FALSE}; # RETAINED 
  if(functionNM=="operators_c7"){record.marker[19,2] <- FALSE}; # RETAINED 
  if(functionNM=="operators_c8"){record.marker[20,2] <- FALSE}; # RETAINED 
  
  saveRDS(record.marker,file = paste0(record.path,"/records_marker_",.plan_count,".rds"));
}

#' @noRd
controller.resetter <- function() {
  running.controller <- new("controller");
  
  points <- rep(T, 5);
  names(points) <- c("c1", "c2", "c3", "c4", "c5");
  
  running.controller@ROI_extract <-
    running.controller@data_import <-
    running.controller@peak_profiling <-
    running.controller@peak_annotation <-
    running.controller@others_1 <- 
    points;
  
  running.controller@operators <- c(F, F, F, F, F, F, F, F);
  
  names(running.controller@operators) <-
    c(
      "operators_1",
      "operators_2",
      "operators_3",
      "operators_4",
      "operators_5",
      "operators_6",
      "operators_7",
      "operators_8"
    );
  
  return(running.controller)
}

controller.modifier <- function(new_command_set, last_command_set, plan){
  
  ###-------------Operators definition ------------//
  
  # operators_1 : PerformDataTrimming ~ PerformParamsOptimization;
  # operators_2 : PerformParamsOptimization ~ peak_profiling;  #' 
  # operators_3 : PerformPeakProfiling ~ PerformPeakAnnotation;  #' 
  # operators_4 : ;
  
  
  # others_1 c1 : Control Optimization or not;
  # others_1 c2 : ;
  # others_1 c3 : ;
  # others_1 c4 : .
  
  ##----------------------------------------------//
  
  if(class(new_command_set) == "OptiCommandSet"){
    
    # 1. ROIExtraction: -----
    # 1.1 Note on controller: c1, read; c2, trim; c3, write; c4, plot; C5, rmConts.
    new_ROIExtraction <- new_command_set@ROIExtraction[[3]];
    last_ROIExtraction <- last_command_set@ROIExtraction[[3]];
    ChangedArugsArray <- NULL;
    
    for (i in 2:length(new_ROIExtraction)){
      for (j in 2:length(last_ROIExtraction)){
        if (names(new_ROIExtraction[i]) == names(last_ROIExtraction[j]) & 
            new_ROIExtraction[[i]] != last_ROIExtraction[[j]]) {
          ChangedArugsArray <- c(ChangedArugsArray, names(new_ROIExtraction[i]))
        } 
      }
    }
    
    newArugsNMs <- names(new_ROIExtraction)[-1];
    lastArugsNMs <- names(last_ROIExtraction)[-1];
    NewArugsArray <- setdiff(newArugsNMs,lastArugsNMs);
    RmArugsArray <- setdiff(lastArugsNMs, newArugsNMs);
    
    ChangedArugsArray <- c(ChangedArugsArray, NewArugsArray, RmArugsArray)
    
    if(is.null(ChangedArugsArray) | length(ChangedArugsArray) == 0){
      # Not changed !
      plan@running.controller@ROI_extract[c(1:5)] <- rep(FALSE, 5);
    }
    
    if("datapath" %in% ChangedArugsArray){
      plan@running.controller@ROI_extract[c(1:5)] <- rep(TRUE,5);
      plan@running.controller@operators[1] <- TRUE;
    } else {
      plan@running.controller@ROI_extract[1] <- FALSE;
    }
    
    if("rmConts" %in% ChangedArugsArray){
      plan@running.controller@ROI_extract[5] <- TRUE;
      plan@running.controller@operators[1] <- TRUE;
    }else {
      plan@running.controller@ROI_extract[5] <- FALSE;
    }
    
    if(any(c("mode", "mz", "mzdiff", "rt", "rtdiff", "rt.idx") %in% ChangedArugsArray)){
      # if any of these params changed, need to run the following steps
      plan@running.controller@ROI_extract[c(2:4)] <- rep(TRUE,3);
      plan@running.controller@operators[1] <- TRUE;
    } else if (any(plan@running.controller@ROI_extract[c(1,5)])){
      # if datapath changed, still need to run the following steps
      plan@running.controller@ROI_extract[c(2:4)] <- rep(TRUE,3);
      plan@running.controller@operators[1] <- TRUE;
    } else {
      # if all these params and datapath did not changed, skipped trimming step
      plan@running.controller@ROI_extract[2] <- FALSE;
    }
    
    if("write" %in% ChangedArugsArray){
      plan@running.controller@ROI_extract[3] <- TRUE;
    }
    
    if("plot" %in% ChangedArugsArray){
      plan@running.controller@ROI_extract[4] <- TRUE;
    }
    
    # 2. ParamsOptimization: -----
    # 2.1 Note on controller: others c1, run or not.
    new_ParamsOptimization <- new_command_set@ParamsOptimization[[3]];
    last_ParamsOptimization <- last_command_set@ParamsOptimization[[3]];
    ChangedArugsArray <- NULL;
    
    for (i in 2:length(new_ParamsOptimization)){
      for (j in 2:length(last_ParamsOptimization)){
        if (names(new_ParamsOptimization[i]) == names(last_ParamsOptimization[j]) & 
            new_ParamsOptimization[[i]] != last_ParamsOptimization[[j]]) {
          ChangedArugsArray <- c(ChangedArugsArray, names(new_ParamsOptimization[i]))
        } 
      }
    }
    
    newArugsNMs <- names(new_ParamsOptimization)[-1];
    lastArugsNMs <- names(last_ParamsOptimization)[-1];
    NewArugsArray <- setdiff(newArugsNMs,lastArugsNMs);
    RmArugsArray <- setdiff(lastArugsNMs, newArugsNMs);
    
    ChangedArugsArray <- c(ChangedArugsArray, NewArugsArray, RmArugsArray)
    
    if(is.null(ChangedArugsArray) | length(ChangedArugsArray) == 0){
      # Not changed !
      plan@running.controller@others_1[1] <- FALSE;
    }
    
    if("param" %in% ChangedArugsArray){
      
      if(length(RmArugsArray == "param") != 0){
        if(RmArugsArray == "param"){
          # refer to: the omitted Argus is param
          if(last_ParamsOptimization$param == "SetPeakParam()"){
            # handle: the omitted param is SetPeakParam()
            plan@running.controller@others_1[1] <- FALSE;
          } else {
            # handle: the omitted param is not SetPeakParam()
            plan@running.controller@others_1[1] <- TRUE;
          }
        }
      }
      
      if (length(NewArugsArray == "param") != 0) {
        if (NewArugsArray == "param") {
          # refer to: the added Argus is param
          if (new_ParamsOptimization$param == "SetPeakParam()") {
            # handle: the added param is SetPeakParam()
            plan@running.controller@others_1[1] <- FALSE;
          } else {
            # handle: the added param is not SetPeakParam()
            plan@running.controller@others_1[1] <- TRUE;
          }
        }
      }
      
      if (length(NewArugsArray == "param") == 0 & 
          length(RmArugsArray == "param") == 0) {
        plan@running.controller@others_1[1] <- TRUE;
      }
      
    }
    
    if(plan@running.controller@operators[1]){
      # Data ROI changed ! Optimization has to be re-run !
      plan@running.controller@others_1[1] <- TRUE;
    }
    
    if(plan@running.controller@others_1[1]){
      # the peak profiling also need to be re-run
      plan@running.controller@operators[2] <- TRUE;
    }
  }
  
  # 3. ImportRawMSData: -----
  # 3.1 Note on controller: others c2, data import. c3, plot.
  
  new_ImportRawMSData <- new_command_set@ImportRawMSData[[3]];
  last_ImportRawMSData <- last_command_set@ImportRawMSData[[3]];
  ChangedArugsArray <- NULL;
  
  for (i in 2:length(new_ImportRawMSData)){
    for (j in 2:length(last_ImportRawMSData)){
      if (names(new_ImportRawMSData[i]) == names(last_ImportRawMSData[j]) & 
          new_ImportRawMSData[[i]] != last_ImportRawMSData[[j]]) {
        ChangedArugsArray <- c(ChangedArugsArray, names(new_ImportRawMSData[i]))
      } 
    }
  }
  
  newArugsNMs <- names(new_ImportRawMSData)[-1];
  lastArugsNMs <- names(last_ImportRawMSData)[-1];
  NewArugsArray <- setdiff(newArugsNMs,lastArugsNMs);
  RmArugsArray <- setdiff(lastArugsNMs, newArugsNMs);
  
  ChangedArugsArray <- c(ChangedArugsArray, NewArugsArray, RmArugsArray);
  
  if(is.null(ChangedArugsArray) | length(ChangedArugsArray) == 0){
    # Not changed !
    plan@running.controller@data_import[c(1:2)] <- rep(TRUE, 2);
  }
  
  if("foldername" %in% ChangedArugsArray){
    plan@running.controller@data_import[1] <- TRUE;
  }
  
  if("plotSettings" %in% ChangedArugsArray){
    plan@running.controller@data_import[2] <- TRUE;
  }
  
  # 4. PeakProfiling: -----
  # 4.1 Note on controller peak_profiling: c1, peak picking; c2, peak alignment; c3, peak filing; c4, plotting.
  
  new_PeakProfiling <- new_command_set@PeakProfiling[[3]];
  last_PeakProfiling <- last_command_set@PeakProfiling[[3]];
  ChangedArugsArray <- NULL;
  
  for (i in 2:length(new_PeakProfiling)){
    for (j in 2:length(last_PeakProfiling)){
      if (names(new_PeakProfiling[i]) == names(last_PeakProfiling[j])) {
        if(new_PeakProfiling[[i]] != last_PeakProfiling[[j]]){
          ChangedArugsArray <- c(ChangedArugsArray, names(new_PeakProfiling[i]))
        }
      } 
    }
  }
  
  newArugsNMs <- names(new_PeakProfiling)[-1];
  lastArugsNMs <- names(last_PeakProfiling)[-1];
  NewArugsArray <- setdiff(newArugsNMs,lastArugsNMs);
  RmArugsArray <- setdiff(lastArugsNMs, newArugsNMs);
  
  ChangedArugsArray <- c(ChangedArugsArray, NewArugsArray, RmArugsArray);
  
  if(is.null(ChangedArugsArray) | length(ChangedArugsArray) == 0){
    # Not changed !
    plan@running.controller@peak_profiling <- rep(FALSE, 4);
    names(plan@running.controller@peak_profiling) <- c("c1","c2","c3","c4");
  }
  
  if(plan@running.controller@operators[2]){
    # OPtimized parameters changed ! re-run everything in peak profiling.
    plan@running.controller@peak_profiling <- rep(TRUE, 4);
    names(plan@running.controller@peak_profiling) <- c("c1","c2","c3","c4");
    
    plan@running.controller@operators[3] <- TRUE;
  }
  
  if("plotSettings" %in% ChangedArugsArray){
    plan@running.controller@peak_profiling[4] <- TRUE;
  }
  
  if(.on.public.web){
    # load params.rda and envir.rds and do a comparison
    envir.path <- paste0(getwd(),"/temp/envir");
    envir_tmp <- readRDS(paste0(envir.path,"/envir.rds"));
    last_param <- envir_tmp[["param"]];
    load("params.rda");
    new_param <- peakParams;
    # TODO: need to configure with the web; handle the annotate params at the same time
    
  } else {
    
    if("Params" %in% ChangedArugsArray){
      
      newParamArgus <- new_PeakProfiling$Params;
      lastParamArgus <- last_PeakProfiling$Params;
      
      ChangedParamArgus <- ParamsChanged(lastParamArgus, newParamArgus);
      
      if(is.null(ChangedParamArgus)){
        plan@running.controller@peak_profiling[c(1:3)] <- rep(FALSE,3);
      } else if (any(ChangedParamArgus %in% c("min_peakwidth","max_peakwidth","mzdiff","ppm","noise","prefilter","value_of_prefilter",
                                              "Peak_method","snthresh","fwhm","sigma","steps"))){
        plan@running.controller@peak_profiling[c(1:3)] <- rep(TRUE,3);
        plan@running.controller@operators[3] <- TRUE;
      } else if (any(ChangedParamArgus %in% c("bw","RT_method","minFraction","minSamples","maxFeatures","family","smooth",
                                              "span","integrate","mzCenterFun","fitgauss"))){
        plan@running.controller@peak_profiling[c(1:3)] <- c(FALSE, TRUE, TRUE);
        plan@running.controller@operators[3] <- TRUE;
      } else if (ChangedParamArgus == "all"){
        plan@running.controller@peak_profiling[c(1:3)] <- rep(TRUE,3);
        plan@running.controller@operators[3] <- TRUE;
      }
    }
  }
  
  # 5. PeakAnnotation: -----
  # 5.1 Note on controller PeakAnnotation: c1, peak annotation; others not used for now.
  
  new_PeakAnnotation <- new_command_set@PeakAnnotation[[3]];
  last_PeakAnnotation <- last_command_set@PeakAnnotation[[3]];
  ChangedArugsArray <- NULL;
  
  for (i in 2:length(new_PeakAnnotation)){
    for (j in 2:length(last_PeakAnnotation)){
      if (names(new_PeakAnnotation[i]) == names(last_PeakAnnotation[j])) {
        if(new_PeakAnnotation[[i]] != last_PeakAnnotation[[j]]){
          ChangedArugsArray <- c(ChangedArugsArray, names(new_PeakAnnotation[i]))
        }
      } 
    }
  }
  
  newArugsNMs <- names(new_PeakAnnotation)[-1];
  lastArugsNMs <- names(last_PeakAnnotation)[-1];
  NewArugsArray <- setdiff(newArugsNMs,lastArugsNMs);
  RmArugsArray <- setdiff(lastArugsNMs, newArugsNMs);
  
  ChangedArugsArray <- c(ChangedArugsArray, NewArugsArray, RmArugsArray);
  
  if(.on.public.web){
    # load params.rda and envir.rds and do a comparison
    # TODO: need to configure with the web and profiling
    
  } else {
    
    if ("annotaParam" %in% ChangedArugsArray) {
      newAnnoParamArgus <- new_PeakAnnotation$annotaParam;
      lastAnnoParamArgus <- last_PeakAnnotation$annotaParam;
      
      ChangedParamArgus <-
        ParamsChanged(lastAnnoParamArgus, newAnnoParamArgus);
      
      if (is.null(ChangedParamArgus)) {
        plan@running.controller@peak_annotation[1] <- FALSE;
      } else {
        plan@running.controller@peak_annotation[1] <- TRUE;
      }
    } else {
      plan@running.controller@peak_annotation[1] <- FALSE;
    }
  }
  
  if(plan@running.controller@operators[3]){
    plan@running.controller@peak_annotation[1] <- TRUE;
  }
  
  # 6. FormatPeakList: -----
  # 6.1 Note on controller FormatPeakList.
  # No need to resume for this function
  
  return(plan)
}

#' @noRd
perform.plan <- function(plan.set){
  
  if(class(plan.set) == "OptiCommandSet"){
    perform.command(plan.set@ROIExtraction);
    perform.command(plan.set@ParamsOptimization);
    perform.command(plan.set@ImportRawMSData);
    perform.command(plan.set@PeakProfiling);
    perform.command(plan.set@PeakAnnotation);
    perform.command(plan.set@FormatPeakList);
  }
  
  if(class(plan.set) == "CustCommandSet"){
    perform.command(plan.set@ImportRawMSData);
    perform.command(plan.set@PeakProfiling);
    perform.command(plan.set@PeakAnnotation);
    perform.command(plan.set@FormatPeakList);
  }
}

#' @noRd
perform.command <- function(command){
  
  if (as.character(command[[1]])=="<-"){
    
    eval(command,envir = envir);
    
    envir.path <- paste0(getwd(),"/temp/envir");
    saveRDS(envir, file = paste0(envir.path,"/envir.rds"));
  } else {
    
    eval(command,envir = envir);
    
    envir.path <- paste0(getwd(),"/temp/envir");
    saveRDS(envir, file = paste0(envir.path,"/envir.rds"));
  }
  
}

#' @noRd
cache.save <- function(obj, funpartnm){
  
  tmp_path <- paste0(getwd(),"/temp/cache");
  if (!dir.exists(tmp_path)){dir.create(tmp_path,recursive = T)};
  temp <- tempfile(tmpdir=tmp_path,fileext = ".rds");
  saveRDS(obj,file = temp);
  
  tmp_path_r <- paste0(getwd(),"/temp/records");
  if (!dir.exists(tmp_path_r)){dir.create(tmp_path,recursive = T)};
  if (!file.exists(paste0(getwd(),"/temp/records/file_record.rds"))){
    
  };
  temp_file_name <- basename(temp)
  info.save(funpartnm, tmp_path_r, temp_file_name)
}

#' @noRd
info.save <- function(funpartnm, tmp_path_r, temp_file_name){
  
  info.matrix <- readRDS(paste0(tmp_path_r,"/records.rds"));
  if (identical(which(info.matrix[,1] == funpartnm),integer(0))){
    record.row <- which(is.na(info.matrix[,1]))[1];
  } else {
    record.row <- which(info.matrix[,1]==funpartnm)[1];
  }
  
  info.matrix[record.row,1] <- funpartnm;
  info.matrix[record.row,2] <- temp_file_name;
  
  saveRDS(info.matrix,file = paste0(tmp_path_r,"/records.rds"))
}

#' @noRd
cache.read <- function(function.name, point){
  
  info.matrix <- readRDS(paste0(getwd(),"/temp/records/records.rds"));
  temp_point <- paste0(function.name,"_",point);
  temp_file <- info.matrix[match(temp_point,info.matrix[,1]),2];
  
  obj <- readRDS(paste0(getwd(),"/temp/cache/",temp_file));
  
  return(obj)
  
}

#' @noRd
profiling_param_identifier <- function(new_command,last_command){
  
  new <- eval(new_command,envir = envir);
  last <- eval(last_command,envir = envir);
  diff.names <- character();
  
  for (i in 1:length(new)){
    for (j in 1:length(last)){
      
      if ((names(new[i]) == names(last[j]))){
        if (unlist(unname(new[i])) != unlist(unname(last[j]))) {
          diff.names <- c(diff.names,names(new[i]))
        }
      }
    }
  };
  return(diff.names)
  
}

#' @noRd
CommandsVerify <- function(commands){
  
  CustPipeline <- OptiPipeline <- FALSE;

  # Identify if the commandset is automated optimization
  OptiPipeline <- any(unlist(lapply(
    commands,
    FUN = function(x) {
      if (class(x[[3]]) == "call") {
        if (x[[3]][[1]] == "PerformParamsOptimization") {
          return(TRUE)
        }
      }
    }
  )))
  
  CustPipeline <- all(unlist(lapply(
    commands,
    FUN = function(x) {
      if (class(x[[3]]) == "call") {
        if (x[[3]][[1]] == "PerformParamsOptimization") {
          return(FALSE)
        } else {
          return(TRUE)
        }
      }
    }
  )))
  
  # Organize the commands as a standard opti/cust commandset for next step
  # including folowing parts:
  
  # 1. PerformROIExtraction / PerformDataTrimming;
  # 2. PerformParamsOptimization;
  # 3. ImportRawMSData;
  # 4. PerformPeakProfiling;
  # 5. PerformPeakAnnotation;
  # 6. FormatPeakList;
  
  if(OptiPipeline){
    
    VARCommandArray <- NULL;
    FUNCommandArray <- NULL;
    StandCommand <- new("OptiCommandSet");
    
    for (i in seq_along(commands)){

      if(class(commands[[i]][[3]]) == "call"){
        
        if(commands[[i]][[3]][[1]] == "PerformDataTrimming" | commands[[i]][[3]][[1]] == "PerformROIExtraction"){
          FUNCommandArray <- c(FUNCommandArray, i);
          tmp_command <- CommandOrganize(commands[[i]], commands, i);
          
          ArguList <- c("datapath", "mode", "write", "mz", "mzdiff", "rt", "rtdiff", "rt.idx", "plot", "running.controller");
          ArgNM <- ArguList[which(names(tmp_command[[3]])[-1] == "")];
          ArgPos <- which(ArgNM == ArguList);
          names(tmp_command[[3]])[ArgPos + 1] <- ArgNM;
          
          StandCommand@ROIExtraction <- tmp_command;
        }
        
        if(commands[[i]][[3]][[1]] == "PerformParamsOptimization"){
          FUNCommandArray <- c(FUNCommandArray, i);
          tmp_command <- CommandOrganize(commands[[i]], commands, i);
          
          ArguList <- c("mSet", "param", "method", "ncore", "running.controller");
          ArgNM <- ArguList[which(names(tmp_command[[3]])[-1] == "")];
          ArgPos <- which(ArgNM == ArguList);
          names(tmp_command[[3]])[ArgPos + 1] <- ArgNM;
          
          StandCommand@ParamsOptimization <- tmp_command;
        }
        
        if(commands[[i]][[3]][[1]] == "ImportRawMSData"){
          FUNCommandArray <- c(FUNCommandArray, i);
          tmp_command <- CommandOrganize(commands[[i]], commands, i);
          
          ArguList <- c("mSet", "foldername", "mode", "ncores", "plotSettings", "running.controller");
          ArgNM <- ArguList[which(names(tmp_command[[3]])[-1] == "")];
          ArgPos <- which(ArgNM == ArguList);
          names(tmp_command[[3]])[ArgPos + 1] <- ArgNM;
          
          StandCommand@ImportRawMSData <- tmp_command;
        }
        
        if(commands[[i]][[3]][[1]] == "PerformPeakProfiling"){
          FUNCommandArray <- c(FUNCommandArray, i);
          tmp_command <- CommandOrganize(commands[[i]], commands, i);
          
          ArguList <- c("mSet", "Params", "plotSettings", "ncore", "running.controller");
          ArgNM <- ArguList[which(names(tmp_command[[3]])[-1] == "")];
          ArgPos <- which(ArgNM == ArguList);
          names(tmp_command[[3]])[ArgPos + 1] <- ArgNM;
          
          StandCommand@PeakProfiling <- tmp_command;
        }
        
        if(commands[[i]][[3]][[1]] == "PerformPeakAnnotation"){
          FUNCommandArray <- c(FUNCommandArray, i);
          tmp_command <- CommandOrganize(commands[[i]], commands, i);
          
          ArguList <- c("mSet", "annotaParam", "ncore", "running.controller");
          ArgNM <- ArguList[which(names(tmp_command[[3]])[-1] == "")];
          ArgPos <- which(ArgNM == ArguList);
          names(tmp_command[[3]])[ArgPos + 1] <- ArgNM;
          
          StandCommand@PeakAnnotation <- tmp_command;
        }
        
        if(commands[[i]][[3]][[1]] == "FormatPeakList"){
          FUNCommandArray <- c(FUNCommandArray, i);
          tmp_command <- CommandOrganize(commands[[i]], commands, i);
          
          ArguList <- c("mSet", "annParams", "filtIso", "filtAdducts", "missPercent");
          ArgNM <- ArguList[which(names(tmp_command[[3]])[-1] == "")];
          ArgPos <- which(ArgNM == ArguList);
          names(tmp_command[[3]])[ArgPos + 1] <- ArgNM;
          
          StandCommand@FormatPeakList <- tmp_command;
        }
        
      }
      
    }
    
    if(length(commands) > 6){
      cat("More functions than standard OptiPipeline were detected !\n")
      cat(paste0("NOTE: Only ",paste(scales::ordinal(FUNCommandArray),collapse = ", "), 
                     " functions in this plan and their direct defination on the argument will be included !\n"))
    }
  }
  
  if(CustPipeline){
    
    VARCommandArray <- NULL;
    FUNCommandArray <- NULL;
    StandCommand <- new("CustCommandSet");
    
    for (i in seq_along(commands)){
      
      if(class(commands[[i]][[3]]) == "call"){
        
        if(commands[[i]][[3]][[1]] == "ImportRawMSData"){
          FUNCommandArray <- c(FUNCommandArray, i);
          tmp_command <- CommandOrganize(commands[[i]], commands, i);
          
          ArguList <- c("mSet", "foldername", "mode", "ncores", "plotSettings", "running.controller");
          ArgNM <- ArguList[which(names(tmp_command[[3]])[-1] == "")];
          ArgPos <- which(ArgNM == ArguList);
          names(tmp_command[[3]])[ArgPos + 1] <- ArgNM;
          
          StandCommand@ImportRawMSData <- tmp_command;
        }
        
        if(commands[[i]][[3]][[1]] == "PerformPeakProfiling"){
          FUNCommandArray <- c(FUNCommandArray, i);
          tmp_command <- CommandOrganize(commands[[i]], commands, i);
          
          ArguList <- c("mSet", "Params", "plotSettings", "ncore", "running.controller");
          ArgNM <- ArguList[which(names(tmp_command[[3]])[-1] == "")];
          ArgPos <- which(ArgNM == ArguList);
          names(tmp_command[[3]])[ArgPos + 1] <- ArgNM;
          
          StandCommand@PeakProfiling <- tmp_command;
        }
        
        if(commands[[i]][[3]][[1]] == "PerformPeakAnnotation"){
          FUNCommandArray <- c(FUNCommandArray, i);
          tmp_command <- CommandOrganize(commands[[i]], commands, i);
          
          ArguList <- c("mSet", "annotaParam", "ncore", "running.controller");
          ArgNM <- ArguList[which(names(tmp_command[[3]])[-1] == "")];
          ArgPos <- which(ArgNM == ArguList);
          names(tmp_command[[3]])[ArgPos + 1] <- ArgNM;
          
          StandCommand@PeakAnnotation <- tmp_command;
        }
        
        if(commands[[i]][[3]][[1]] == "FormatPeakList"){
          FUNCommandArray <- c(FUNCommandArray, i);
          tmp_command <- CommandOrganize(commands[[i]], commands, i);
          
          ArguList <- c("mSet", "annParams", "filtIso", "filtAdducts", "missPercent");
          ArgNM <- ArguList[which(names(tmp_command[[3]])[-1] == "")];
          ArgPos <- which(ArgNM == ArguList);
          names(tmp_command[[3]])[ArgPos + 1] <- ArgNM;
          
          StandCommand@FormatPeakList <- tmp_command;
        }
        
      }
      
    }
    
    if(length(commands) > 4){
      cat("More functions than standard OptiPipeline were detected !\n")
      cat(paste0("NOTE: Only ",paste(scales::ordinal(FUNCommandArray),collapse = ", "), 
                   " functions in this plan and their direct defination on the argument will be included !\n"))
    }
    
  }
  
  return(StandCommand)
}

#' @noRd
CommandOrganize <- function(command, commands, FUNPos){
  
  varNMs <- as.character(command[[3]]);
  if(varNMs[1] == "PerformROIExtraction"){
    Vars <- varNMs[-1];
  } 
  
  if(varNMs[2] != "mSet"){
    Vars <- varNMs[-1];
  } else {
    Vars <- varNMs[c(-1,-2)];
  }
  
  for (i in Vars){
    
    VARDefinedPos <- NULL;
    VarPos <- which(varNMs == i);
    
    for (j in seq_len(FUNPos)){
      if (commands[[j]][[2]] == i){
        VARDefinedPos <- c(VARDefinedPos, j);
      }
    }
    
    if (is.null(VARDefinedPos)) {
      next()
    } else if(length(VARDefinedPos) == 1) {
      command[[3]][[VarPos]]<- commands[[VARDefinedPos]][[3]];
    } else if(length(VARDefinedPos) > 1) {
      VARDefinedPos <- VARDefinedPos[which.min(abs(VARDefinedPos - FUNPos))];
      command[[3]][[VarPos]]<- commands[[VARDefinedPos]][[3]];
    }
  }
  
  return(command)
}

#' @noRd
CreateRawRscript <- function(guestName, planString, planString2, rawfilenms.vec){
  
  guestName <<- guestName;
  planString <<- planString;
  
  if(dir.exists("/home/glassfish/payara5/glassfish/domains/")){
    
    scr.path <- "/home/glassfish/payara5/glassfish/domains/domain1/applications/MetaboAnalyst/resources/rscripts/metaboanalystr/"
    users.path <-paste0("/data/glassfish/projects/metaboanalyst//", guestName)
    
  } else if(dir.exists("/media/zzggyy/disk/")){
    
    users.path <-getwd();
    scr.path <-"/media/zzggyy/disk/MetaboAnalyst/target/MetaboAnalyst-5-18/resources/rscripts/metaboanalystr/"
    
  }else {
    
    users.path <-getwd();
    scr.path <-paste0(strsplit(users.path, "users")[[1]][1], "rscripts/metaboanalystr/")
    
  }
  
  ## Prepare the script for running
  str <- paste0('scripts.path <- ','"', scr.path,'"');
  str <- paste0(str, '\n', 'general_files <- c("general_data_utils.R","general_misc_utils.R","general_lib_utils.R","generic_c_utils.R");')
  str <- paste0(str, '\n', 'spectra_files <- c("spectra_generic_utils.R","data_trimming.R","parameters_db.R","parameters_optimization.R","preproc_utils.R","spectra_resume.R","spectra_utils.R");')
  str <- paste0(str, '\n', 'rawfilenms <<-', rawfilenms.vec)
  str <- paste0(str, '\n', 'err.vec <<-', '""')
  str <- paste0(str, '\n', '.on.public.web <<- TRUE')
  str <- paste0(str, '\n', 'file.sources = c(general_files, spectra_files)')
  str <- paste0(str, '\n', 'for (f in file.sources) {source(paste0(scripts.path, f))}')
  
  ## Construct the opt pipeline
  if(planString2 == "opt"){
    str <- paste0(str, '\n', 'plan <- InitializaPlan("raw_opt","' , users.path,  '/")')
    str <- paste0(str, '\n', 'data_folder_QC <- "',users.path , '/upload/QC/"')
    str <- paste0(str, '\n',  planString)
    str <- paste0(str, '\n',  "ExecutePlan(plan)")
  }
  
  ## Construct the default pipeline
  if(planString2 == "default"){
    str <- paste0(str, '\n', 'plan <- InitializaPlan("raw_ms","' , users.path,  '/")')
    str <- paste0(str, '\n',  planString)
    str <- paste0(str, '\n',  "ExecutePlan(plan)")
  }
  
  # sink command for running
  sink("ExecuteRawSpec.R");
  cat(str);
  sink();
  return(1)
  
}

#' @noRd
CreateRawRscript2 <- function(guestName, meth){
  
  guestName <<- guestName;  
  
  if(dir.exists("/home/glassfish/payara5/glassfish/domains/")){
    
    scr.path <- "/home/glassfish/payara5/glassfish/domains/domain1/applications/MetaboAnalyst/resources/rscripts/metaboanalystr/"
    users.path <-paste0("/data/glassfish/projects/metaboanalyst/", guestName)
    
  } else {
    
    users.path <-getwd();
    scr.path <-paste0(strsplit(users.path, "users")[[1]][1], "rscripts/metaboanalystr/")
    
  }
  
  str <- paste0('scripts.path <- ','"', scr.path,'"');
  str <- paste0(str, '\n', 'general_files <- c("general_data_utils.R","general_misc_utils.R","general_lib_utils.R","generic_c_utils.R");')
  str <- paste0(str, '\n', 'spectra_files <- c("spectra_generic_utils.R","data_trimming.R","parameters_db.R","parameters_optimization.R","preproc_utils.R","spectra_resume.R","spectra_utils.R");')
  str <- paste0(str, '\n', '.on.public.web <<- TRUE')
  str <- paste0(str, '\n', 'file.sources = c(general_files, spectra_files)')
  str <- paste0(str, '\n', 'for (f in file.sources) {source(paste0(scripts.path, f))}')
  
  
  ## Prepare the script for running
  if(meth == "auto"){
    str <- paste0(str, '\n', 'FastRunningShow_auto ("',users.path,'")');
  } else {
    str <- paste0(str, '\n', 'FastRunningShow_customized ("',users.path,'")');
  }
  
  # sink command for running
  sink("ExecuteRawSpec.R");
  cat(str);
  sink();
  return(1)
  
}

#' @noRd
ParamsChanged <- function(lastParamArgus, newParamArgus){
  
  if (is.call(newParamArgus) & is.call(lastParamArgus)){
    new_param <- eval(newParamArgus);
    last_param <- eval(lastParamArgus);
    
    identifiers <- NULL;
    
    for (i in 1:length(new_param)){
      for (j in 1:length(last_param)){
        if (names(new_param[i])==names(last_param[j]) & new_param[[i]] != last_param[[j]]){
          identifiers <- c(identifiers, names(new_param[i]))
        }
      }
    }
    
    return(identifiers)
    
  } else {
    return("all")
  }
  
}

#' @noRd
OptiFileChanged <- function(data_trim_folder){
  
  envir_previous <- readRDS(paste0(fullUserPath,"/temp/envir/envir.rds"));
  optifiles_last <- try(envir_previous[["mSet"]]@rawInMemory@phenoData@data[["sample_name"]],silent = T);
  optifiles_current <- list.files(data_trim_folder,recursive = TRUE);
  
  if(is.null(optifiles_last) | class(optifiles_last) == "try-error"){
    return(FALSE);
  }
  
  if(all(nchar(optifiles_last) != nchar(optifiles_current))){
    return(TRUE);
  }
}

#' @noRd
ProcessFileChanged <- function(data_process_folder){
  
  envir_previous <- readRDS(paste0(fullUserPath,"/temp/envir/envir.rds"));
  optifiles_last <- try(basename(envir_previous[["mSet"]]@rawOnDisk@processingData@files),silent = T);
  optifiles_current <- list.files(data_process_folder, recursive = TRUE);
  
  if(is.null(optifiles_last) | class(optifiles_last) == "try-error"){
    return(FALSE);
  }
  
  if(all(nchar(optifiles_last) != nchar(optifiles_current))){
    return(TRUE);
  }
}

#' @noRd
FastRunningShow_auto <- function(fullUserPath){
  
  setwd(fullUserPath);  
  
  time_interval1 <- 0.65;
  time_interval2 <- 2;
  # running to show the progress
  if (!file.exists("metaboanalyst_spec_proc.txt")){
    print_mes <- paste0("Running Status -- Job Submitted Successfully at: ", Sys.time(), "\nWaiting in queue to start...")
    write.table(print_mes, file = paste0(fullUserPath, "/metaboanalyst_spec_proc.txt"),row.names = F,col.names = F);
  }
  Sys.sleep(time_interval1);
  
  print_mes <- "Step 0/6: Scanning ROIs for parameters optimization...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(1.0, file = "log_progress.txt",row.names = F,col.names = F); 
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Data Loading...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  write.table("Raw file import begin...",file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- paste0("Importing ","QC_PREFA02.mzML",":");    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = " ");
  
  Sys.sleep(time_interval1);
  
  for(i in seq(0,100,20)){
    
    print_mes <- paste0(i,"% | ");    
    write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "");
    Sys.sleep(0.35);
    
  }
  
  print_mes <- paste0(" Done!");    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- paste0("Importing ","QC_PREFB02.mzML",":");    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = " ");
  
  Sys.sleep(time_interval1);
  
  for(i in seq(0,100,20)){
    
    print_mes <- paste0(i,"% | ");    
    write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "");
    Sys.sleep(0.3);
    
  }
  
  print_mes <- paste0(" Done!");    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(2.0, file = "log_progress.txt",row.names = F,col.names = F);
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Data Loaded !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Empty Scan scanning...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "No Empty scan found !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Identifying regions of interest (ROI)...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Identifying regions of potential contaminants ";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "");
  
  Sys.sleep(time_interval1);
  
  for(i in 1:30){
    print_mes <- ".";    
    write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "");
    Sys.sleep(0.75);
  }
  
  print_mes <- "Done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "300 potential contaminamts will not be used for parameters optimization !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "MS data Preparing...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "MS Data ready !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(3.0, file = "log_progress.txt",row.names = F,col.names = F);
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Identifying ROIs in m/z dimensions...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Identifying ROIs in m/z dimensions Done !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Identifying ROIs in RT dimensions...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Identification on ROIs Finished! ";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(4.0, file = "log_progress.txt",row.names = F,col.names = F);
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Optimization will be started soon...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Step 1/6: Start to optimize parameters! ";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "This step may take a long time...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "DoE Optimization Starting Now...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Evaluating Noise level...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(5.00, file = "log_progress.txt",row.names = F,col.names = F);
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Preparing Parameters for optimization finished !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Data Spliting Finished ! ";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Peak Preparing Begin...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Peak Preparing Done !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Round:1";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "DoE Running Begin...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Finished:";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = " ");
  
  for(i in c(11,22,33,44,56,67,78,89,100)){
    
    print_mes <- paste0(i,"% | ");    
    write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "");
    write.table(5+i/50, file = "log_progress.txt",row.names = F,col.names = F);
    Sys.sleep(2);
    
  }
  
  print_mes <- "Done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  print_mes <- "Round 1 Finished !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Model Parsing...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Model Parsing Done !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Round:2";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "DoE Running Begin...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Finished:";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = " ");
  
  for(i in c(11,22,33,44,56,67,78,89,100)){
    
    print_mes <- paste0(i,"% | ");    
    write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "");
    write.table(8.0+1/50, file = "log_progress.txt",row.names = F,col.names = F);
    Sys.sleep(0.5);
    
  }
  
  print_mes <- "Done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  print_mes <- "Round 2 Finished !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Model Parsing...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Model Parsing Done !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  
  print_mes <- "Round:3";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "DoE Running Begin...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Finished:";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = " ");
  
  for(i in c(11,22,33,44,56,67,78,89,100)){
    
    print_mes <- paste0(i,"% | ");    
    write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "");
    write.table(8.0+1/50, file = "log_progress.txt",row.names = F,col.names = F);
    Sys.sleep(0.5);
    
  }
  
  print_mes <- "Done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  print_mes <- "Round 3 Finished !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Model Parsing...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Model Parsing Done !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- paste0("Step 1/6: Parameters Optimization Finished ! (", Sys.time(),")");
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(20.0, file = "log_progress.txt",row.names = F,col.names = F);
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Step 2/6: Start to import the spectrum! ";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(21.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "This step will take a short time...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Raw file import begin...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "CD-6KUCT.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "CD-77FXR.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "CD-9OS5Y.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "CD-9WOBP.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "HC-9SNJ4.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "HC-9X47O.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "HC-AMR37.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "HC-AUP8B.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "QC_PREFA02.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "QC_PREFB02.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(22.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(3);
  
  print_mes <- "Raw file initialized Successfully!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(24.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- paste0("Step 2/6: Successfully imported raw MS data! (", Sys.time(),") \nGoing to the next step...");
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Parameters for centWave have been successfully parsed!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "4 CPU Threads will be used for peak profiling !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(25, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Step 3/6: Started peak picking! This step will take some time...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 1.91 ppm ... Detecting peaks in 3613 regions of interest ... OK: 551 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(30.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 1.91 ppm ... Detecting peaks in 3528 regions of interest ... OK: 591 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(30.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 1.91 ppm ... Detecting peaks in 5098 regions of interest ... OK: 598 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(35.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 1.91 ppm ... Detecting peaks in 3953 regions of interest ... OK: 805 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(35.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 1.91 ppm ... Detecting peaks in 4875 regions of interest ... OK: 676 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(40.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 1.91 ppm ... Detecting peaks in 5333 regions of interest ... OK: 717 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(40.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 1.91 ppm ... Detecting peaks in 4991 regions of interest ... OK: 805 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(40.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 1.91 ppm ... Detecting peaks in 4633 regions of interest ... OK: 847 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(40.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 1.91 ppm ... Detecting peaks in 4988 regions of interest ... OK: 791 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(47.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 1.91 ppm ... Detecting peaks in 5069 regions of interest ... OK: 755 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(47.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- paste0("Step 3/6: Peak picking finished ! (",Sys.time(),")");
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(50.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Step 4/6: Started peak alignment! This step is running...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(52.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Total of 2803 slices detected for processing... Done ! ";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(55.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Going to the next step...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(56.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Retention time correction is running.....";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(60.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Performing retention time correction using  92  peak groups.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(65.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Applying retention time adjustment to the identified chromatographic peaks ... Done !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(66.0, file = "log_progress.txt",row.names = F,col.names = F);
  write.table(68.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Total of 2803 slices detected for processing... Done ! ";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Going to the next step...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- paste0("Step 4/6: Peak alignment finished ! (",Sys.time(),")");
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(73.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Step 5/6: Started peak filling! This step may take some time...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Starting peak filling!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(74.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Defining peak areas for filling-in...... OK";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Start integrating peak areas from original files...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(77.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 296 peaks from CD-6KUCT.mzML ...  got  150 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(78.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 420 peaks from CD-9WOBP.mzML ...  got  146 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(79.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 380 peaks from HC-9X47O.mzML ...  got  192 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(80.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 371 peaks from HC-AUP8B.mzML ...  got  197 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(81.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 35 peaks from QC_PREFA02.mzML ...  got  32 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 275 peaks from CD-77FXR.mzML ...  got  148 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(82.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 33 peaks from QC_PREFB02.mzML ...  got  30 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(83.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 358 peaks from HC-AMR37.mzML ...  got  173 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(84.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 356 peaks from HC-9SNJ4.mzML ...  got  189 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(85.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 283 peaks from CD-9OS5Y.mzML ...  got  160 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(86.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- paste0("Step 5/6: Peak filing finished ! (",Sys.time(),")");
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(88.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Peak Profiling finished successfully !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Begin to plotting figures...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(89.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Step 6/6: Starting Peak Annotation...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(91.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Start grouping after retention time.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Created 68 pseudospectra.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(92.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Generating peak matrix...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Run isotope peak annotation..";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(93.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Found isotopes:108";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Start grouping after correlation...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(94.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Generating EIC's....";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Detecting  CD-6KUCT.mzML  ... 37 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Detecting  CD-77FXR.mzML  ... 43 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Detecting  CD-9OS5Y.mzML  ... 54 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Detecting  CD-9WOBP.mzML  ... 124 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Detecting  HC-9SNJ4.mzML  ... 28 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(95.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Detecting  HC-9X47O.mzML  ... 0 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  print_mes <- "Detecting  HC-AMR37.mzML  ... 170 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Detecting  HC-AUP8B.mzML  ... 20 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Detecting  QC_PREFA02.mzML  ... 64 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Detecting  QC_PREFB02.mzML  ... 87 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Calculating graph cross linking in 68 Groups...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(96.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "New number of ps-groups:  406";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "mSet has now 406 groups, instead of 68 !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Generating peak matrix for peak annotation!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Polarity is set in annotaParam: negative";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(97.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Ruleset could not read from object! Recalculating...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- paste0("Step 6/6: Successfully performed peak annotation! (",Sys.time(),")");
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(98.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Going to the final step...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(99.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- paste0("Everything has been finished Successfully ! (",Sys.time(),")");
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(100.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
}

#' @noRd
FastRunningShow_customized <- function(fullUserPath){
  print(fullUserPath);
  setwd(fullUserPath);    
  
  time_interval1 <- 0.80;
  time_interval2 <- 2;
  # running to show the progress
  if (!file.exists("metaboanalyst_spec_proc.txt")){
    print_mes <- paste0("Running Status -- Job Submitted Successfully at: ", Sys.time(), "\nWaiting in queue to start...")
    write.table(print_mes, file = paste0(fullUserPath, "/metaboanalyst_spec_proc.txt"),row.names = F,col.names = F);
  }
  Sys.sleep(time_interval1);
  
  print_mes <- paste0("Step 1/6: Internalize parameters!");
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(1.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- paste0("This step will be finished soon...");
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(2.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- paste0("Step 1/6: Parameters Internalized Successfully! ");
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(15.0, file = "log_progress.txt",row.names = F,col.names = F);
  
  Sys.sleep(time_interval1);
  
  print_mes <- paste0("Going to the next step...");
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(20.0, file = "log_progress.txt",row.names = F,col.names = F);
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Step 2/6: Start to import the spectrum! ";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(21.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "This step will take a short time...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Raw file import begin...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "CD-6KUCT.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "CD-77FXR.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "CD-9OS5Y.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "CD-9WOBP.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "HC-9SNJ4.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "HC-9X47O.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "HC-AMR37.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "HC-AUP8B.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "QC_PREFA02.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "QC_PREFB02.mzML import done!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(22.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(3);
  
  print_mes <- "Raw file initialized Successfully!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(24.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- paste0("Step 2/6: Successfully imported raw MS data! (", Sys.time(),") \nGoing to the next step...");
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Parameters for centWave have been successfully parsed!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "4 CPU Threads will be used for peak profiling !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(25, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Step 3/6: Started peak picking! This step will take some time...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 5 ppm ... Detecting peaks in 5509 regions of interest ... OK: 1285 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(30.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 5 ppm ... Detecting peaks in 5355 regions of interest ... OK: 1395 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(30.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 5 ppm ... Detecting peaks in 6009 regions of interest ... OK: 1327 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(35.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 5 ppm ... Detecting peaks in 5767 regions of interest ... OK: 1810 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(35.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 5 ppm ... Detecting peaks in 5832 regions of interest ... OK: 1507 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(40.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 5 ppm ... Detecting peaks in 6273 regions of interest ... OK: 1586 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(40.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 5 ppm ... Detecting peaks in 6061 regions of interest ... OK: 1643 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(40.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 5 ppm ... Detecting peaks in 5926 regions of interest ... OK: 1805 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(40.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 5 ppm ... Detecting peaks in 6054 regions of interest ... OK: 1646 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(47.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Searching under 5 ppm ... Detecting peaks in 6299 regions of interest ... OK: 1608 found.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(47.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- paste0("Step 3/6: Peak picking finished ! (",Sys.time(),")");
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(50.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Step 4/6: Started peak alignment! This step is running...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(52.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Total of 2805 slices detected for processing... Done ! ";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(55.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Going to the next step...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(56.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Retention time correction is running.....";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(60.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Performing retention time correction using  54  peak groups.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(65.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Applying retention time adjustment to the identified chromatographic peaks ... Done !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(66.0, file = "log_progress.txt",row.names = F,col.names = F);
  write.table(68.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Total of 2805 slices detected for processing... Done ! ";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Going to the next step...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- paste0("Step 4/6: Peak alignment finished ! (",Sys.time(),")");
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(73.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Step 5/6: Started peak filling! This step may take some time...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Starting peak filling!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(74.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Defining peak areas for filling-in...... OK";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Start integrating peak areas from original files...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(77.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 139 peaks from CD-6KUCT.mzML ...  got  56 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(78.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 256 peaks from CD-9WOBP.mzML ...  got  55 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(79.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 261 peaks from HC-9X47O.mzML ...  got  101 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(80.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 234 peaks from HC-AUP8B.mzML ...  got  95 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(81.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 199 peaks from HC-AMR37.mzML ...  got  72 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 206 peaks from HC-9SNJ4.mzML ...  got  94 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(82.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 146 peaks from CD-77FXR.mzML ...  got  61 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(83.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 52 peaks from QC_PREFA02.mzML ...  got  30 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(84.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 188 peaks from CD-9OS5Y.mzML ...  got  74 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(85.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Requesting 54 peaks from QC_PREFB02.mzML ...  got  37 .";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(86.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- paste0("Step 5/6: Peak filing finished ! (",Sys.time(),")");
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(88.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Peak Profiling finished successfully !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Begin to plotting figures...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(89.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Step 6/6: Starting Peak Annotation...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(91.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Start grouping after retention time.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Created 62 pseudospectra.";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(92.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Generating peak matrix...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Run isotope peak annotation..";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(93.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Found isotopes:28";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Start grouping after correlation...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(94.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Generating EIC's....";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Detecting  CD-6KUCT.mzML  ... 66 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Detecting  CD-77FXR.mzML  ... 35 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Detecting  CD-9OS5Y.mzML  ... 219 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Detecting  CD-9WOBP.mzML  ... 120 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Detecting  HC-9SNJ4.mzML  ... 30 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(95.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Detecting  HC-9X47O.mzML  ... 0 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(95.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Detecting  HC-AMR37.mzML  ... 287 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Detecting  HC-AUP8B.mzML  ... 21 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Detecting  QC_PREFA02.mzML  ... 89 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Detecting  QC_PREFB02.mzML  ... 39 peaks found!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Calculating graph cross linking in 62 Groups...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(96.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "New number of ps-groups:  736";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "mSet has now 310 groups, instead of 62 !";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Generating peak matrix for peak annotation!";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- "Polarity is set in annotaParam: negative";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(97.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Ruleset could not read from object! Recalculating...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  
  Sys.sleep(time_interval1);
  
  print_mes <- paste0("Step 6/6: Successfully performed peak annotation! (",Sys.time(),")");
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(98.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- "Going to the final step...";    
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(99.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
  
  print_mes <- paste0("Everything has been finished Successfully ! (",Sys.time(),")");
  write.table(print_mes,file="metaboanalyst_spec_proc.txt",append = T,row.names = F,col.names = F, quote = F, eol = "\n");
  write.table(100.0, file = "log_progress.txt",row.names = F,col.names = F);
  Sys.sleep(time_interval1);
}


#' @param folderPath guest folder
#'
#' @title Cache Update
#' @author Zhiqiang Pang
#' @noRd
CachePathCorrection <- function(folderPath){
  
  cacheFiles <- list.files(paste0(folderPath,"/temp"),all.files = T, full.names = T, recursive = T);
  
  newfilepath <- list.files("/home/glassfish/projects/MetaboDemoRawData/upload",all.files = T, recursive = T,full.names = T)
  
  for (i in cacheFiles){
    tmp_rds <- readRDS(i);
    tmp_names <- names(tmp_rds);
    
    if(class(tmp_rds)[[1]] == "OnDiskMSnExp"){
      
      tmp_rds@processingData@files <- newfilepath;
      
    } else if (class(tmp_rds)[[1]] == "list"){
      
      for(j in tmp_names){
        tmp_obj <- tmp_rds[[j]];
        
        if(class(tmp_obj)[[1]] == "OnDiskMSnExp"){
          tmp_rds[[j]]@processingData@files <- newfilepath;
        }
        
        if(class(tmp_obj)[[1]] == "xcmsSet"){
          tmp_rds[[j]]@filepaths <- newfilepath;
        }
        
      } 
      
    } else if(class(tmp_rds)[[1]] == "environment"){
      
      tmp_rds$annotPeaks$onDiskData@processingData@files <- 
        tmp_rds$annotPeaks$xcmsSet@filepaths <- 
        tmp_rds$mSet$onDiskData@processingData@files <- 
        tmp_rds$mSet$xcmsSet@filepaths <- 
        tmp_rds$rawData@processingData@files <- newfilepath;
      
    }
    
    saveRDS(tmp_rds, file = i);
  }
  
  load(paste0(folderPath,"/","mSet.rda"));
  mSet$onDiskData@processingData@files <- mSet$xcmsSet@filepaths <- newfilepath;
  
  save(mSet, file = paste0(folderPath,"/","mSet.rda"));
  
}

#folderPath <- "/home/qiang/NetBeansProjects/MetaboAnalyst/target/MetaboAnalyst-5.18/resources/users/guest8386191689266673959tmp/"
#CachePathCorrection(folderPath)


## End of the resuming script ---
